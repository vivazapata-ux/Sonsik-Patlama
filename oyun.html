<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">
    <title>Şonşik Patlatma</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #87CEEB; font-family: sans-serif; user-select: none; }
        #ui { position: absolute; top: 20px; left: 20px; color: white; font-size: 24px; font-weight: bold; text-shadow: 2px 2px 0 #000; pointer-events: none; }
        #instruction { position: absolute; bottom: 20px; width: 100%; text-align: center; color: white; font-size: 18px; text-shadow: 1px 1px 0 #000; pointer-events: none; }
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 20px; font-weight: bold; background: rgba(0,0,0,0.5); padding: 20px; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="ui">Şişirme Seviyesi: <span id="counter">0</span>/10</div>
    <div id="instruction">Pompaya Tıkla ve Şonşik'i Şişir!</div>
    <div id="loading">Yükleniyor...</div>

    <script type="module">
        import * as THREE from 'https://unpkg.com/three@0.128.0/build/three.module.js';

        // Değişkenler
        let clickCount = 0;
        const maxClicks = 10;
        let isExploded = false;
        let pumpSound, finalSound;
        let soncikMesh, mayoTexture;
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        const pumpGroup = new THREE.Group();
        let pumpHandle;

        // Başlangıç
        init();
        animate();

        function init() {
            // Sahne Ayarları
            scene.background = new THREE.Color(0x333333);
            camera.position.z = 6;
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // Işıklar
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(5, 5, 5);
            scene.add(dirLight);

            // Sesleri Yükle
            pumpSound = new Audio('ses1.m4a');
            finalSound = new Audio('ses2.m4a');

            // Texture Yükleyici
            const textureLoader = new THREE.TextureLoader();

            // 1. Şonşik Resmi
            textureLoader.load('soncik.jpg', (texture) => {
                const geometry = new THREE.SphereGeometry(2, 32, 32);
                const material = new THREE.MeshStandardMaterial({ map: texture });
                soncikMesh = new THREE.Mesh(geometry, material);
                scene.add(soncikMesh);
                document.getElementById('loading').style.display = 'none';
            }, undefined, (err) => {
                console.error("Resim hatası", err);
                document.getElementById('loading').innerText = "HATA: soncik.jpg bulunamadı";
            });

            // 2. Mayonez Resmi
            textureLoader.load('mayonez.png', (t) => { mayoTexture = t; });

            // Pompa Modeli
            createPump();

            // Event Listener
            window.addEventListener('click', onMouseClick);
            window.addEventListener('resize', onWindowResize);
        }

        function createPump() {
            const matGray = new THREE.MeshStandardMaterial({ color: 0x444444 });
            const matRed = new THREE.MeshStandardMaterial({ color: 0xff0000 });

            const base = new THREE.Mesh(new THREE.CylinderGeometry(0.6, 0.8, 0.3, 32), matGray);
            base.position.y = -2;
            pumpGroup.add(base);

            const body = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 2.5, 16), new THREE.MeshStandardMaterial({ color: 0x888888 }));
            body.position.y = -0.8;
            pumpGroup.add(body);

            pumpHandle = new THREE.Mesh(new THREE.BoxGeometry(1.5, 0.2, 0.5), matRed);
            pumpHandle.position.y = 0.5;
            pumpHandle.name = "pompa";
            pumpGroup.add(pumpHandle);

            pumpGroup.position.set(3.5, -1, 0);
            scene.add(pumpGroup);

            // Hortum
            const curve = new THREE.CatmullRomCurve3([
                new THREE.Vector3(3.3, -1.8, 0),
                new THREE.Vector3(2.5, -2, 0),
                new THREE.Vector3(0, -2, 0)
            ]);
            const hose = new THREE.Mesh(new THREE.TubeGeometry(curve, 20, 0.08, 8, false), new THREE.MeshStandardMaterial({ color: 0x111111 }));
            scene.add(hose);
        }

        function createExplosion() {
            const geo = new THREE.CylinderGeometry(0.2, 0.2, 0.4, 12);
            const mat = mayoTexture ? new THREE.MeshBasicMaterial({ map: mayoTexture, transparent:true }) : new THREE.MeshBasicMaterial({ color: 0xffff00 });
            
            for(let i=0; i<50; i++) {
                const m = new THREE.Mesh(geo, mat);
                m.userData = {
                    vel: new THREE.Vector3((Math.random()-0.5)*1.5, (Math.random()-0.5)*1.5, (Math.random()-0.5)*2+1),
                    rot: { x: Math.random()*0.2, y: Math.random()*0.2 }
                };
                scene.add(m);
                mayoJars.push(m);
            }
        }
        
        const mayoJars = [];

        function onMouseClick(event) {
            if(isExploded) return;

            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects([pumpHandle]);

            if (intersects.length > 0) {
                // Animasyon
                pumpHandle.position.y = -0.3;
                setTimeout(() => pumpHandle.position.y = 0.5, 100);

                clickCount++;
                document.getElementById('counter').innerText = clickCount;

                if(soncikMesh) {
                    const s = 1 + (clickCount * 0.2);
                    soncikMesh.scale.set(s, s, s);
                    soncikMesh.material.color.setHSL(0, 1, 1 - (clickCount * 0.05));
                }

                if (clickCount < maxClicks) {
                    if(pumpSound) { pumpSound.currentTime=0; pumpSound.play().catch(()=>{}); }
                } else {
                    // PATLAMA
                    isExploded = true;
                    if(pumpSound) pumpSound.pause();
                    if(soncikMesh) scene.remove(soncikMesh);
                    createExplosion();
                    document.getElementById('instruction').innerText = "PATLADI! Heinz Mayonezleri Döküldü!";
                    setTimeout(() => { if(finalSound) finalSound.play().catch(()=>{}); }, 500);
                }
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            
            if(!isExploded && soncikMesh) {
                soncikMesh.rotation.y = Math.sin(Date.now() * 0.001) * 0.2;
            } else if(isExploded) {
                mayoJars.forEach(p => {
                    p.position.add(p.userData.vel);
                    p.rotation.x += p.userData.rot.x;
                    p.userData.vel.y -= 0.02;
                });
            }
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    </script>
</body>
</html>